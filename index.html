<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-StarCards - Offline Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .canvas-container {
            touch-action: none;
        }
        .tab-button, .filter-button {
            padding: 0.5rem 1rem;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        .tab-button.active, .filter-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        #custom-modal, #confirm-modal {
            transition: opacity 0.2s ease-in-out;
        }
        .tool-btn.active {
            box-shadow: 0 0 0 3px #4f46e5;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Custom Modal for Notifications -->
    <div id="custom-modal" class="fixed top-0 left-1/2 -translate-x-1/2 -translate-y-full bg-red-500 text-white py-3 px-6 rounded-b-lg shadow-lg z-[100]" style="transition: transform 0.3s ease-in-out;">
        <p id="modal-message">This is an error message.</p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 z-[101]">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 id="confirm-modal-message" class="text-lg font-semibold mb-6">Are you sure?</h3>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-8 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-500 text-white font-semibold py-2 px-8 rounded-lg hover:bg-red-600 transition">Delete</button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-indigo-600 flex items-center justify-center gap-3">
                E-StarCards
                <div class="flex flex-col items-center">
                    <img src="e bees.png" alt="E-StarCards Mascot" class="w-20 h-25">
                    <span class="text-sm text-red-700 font-medium">
                        (Offline Mode)
                    </span>
                </div>
            </h1>
            <p class="mt-2 text-lg text-slate-500">Create and study your flashcards with others.</p>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Deck Creation Section -->
            <section id="create-deck-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                 <h2 class="text-2xl font-bold mb-4">Create a New Deck</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <input type="text" id="deck-name-input" placeholder="Enter Deck Name" class="md:col-span-1 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    <select id="faculty-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <option value="none" selected disabled>Select a Faculty</option>
                        <option value="fci">FCI</option><option value="fob">FOB</option><option value="fac">FAC</option><option value="fom">FOM</option><option value="fcm">FCM</option><option value="fist">FIST</option><option value="faie">FAIE</option><option value="fol">FOL</option><option value="fca">FCA</option>
                    </select>
                    <button id="save-deck-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition shadow-sm">Save Deck</button>
                </div>
                <div class="mt-6 border-t pt-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">Add / Edit Card</h3>
                        <div id="card-creator-form">
                            <!-- Card creation form will be injected here -->
                        </div>
                    </div>
                     <section>
                        <h3 class="text-xl font-bold mb-4">Cards in Current Deck (<span id="card-count">0</span>)</h3>
                        <div id="current-cards-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                             <p class="text-slate-500 text-center">No cards added yet.</p>
                        </div>
                    </section>
                </div>
            </section>

            <!-- Saved Decks Section -->
            <section id="saved-decks-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-2xl font-bold">Our Saved Decks</h2>
                    <div id="faculty-filter-buttons" class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                        <button class="filter-button active" data-faculty="all">All</button>
                        <button class="filter-button" data-faculty="fci">FCI</button><button class="filter-button" data-faculty="fob">FOB</button><button class="filter-button" data-faculty="fac">FAC</button><button class="filter-button" data-faculty="fom">FOM</button><button class="filter-button" data-faculty="fcm">FCM</button><button class="filter-button" data-faculty="fist">FIST</button><button class="filter-button" data-faculty="faie">FAIE</button><button class="filter-button" data-faculty="fol">FOL</button><button class="filter-button" data-faculty="fca">FCA</button>
                    </div>
                </div>
                <div id="decks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="no-decks-msg" class="text-slate-500 col-span-full">No saved decks found. Create one to get started!</p>
                </div>
            </section>
        </main>
        
        <!-- Study Mode View -->
        <div id="study-mode-view" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div id="study-question-panel" class="bg-white w-full max-w-3xl h-full max-h-[90vh] rounded-2xl shadow-2xl flex flex-col p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="study-deck-name" class="text-2xl font-bold">Studying...</h2>
                    <p id="study-progress" class="font-semibold text-slate-500">Card 1 / 10</p>
                </div>
                <div class="flex-grow flex flex-col gap-4 overflow-y-auto">
                    <div class="bg-slate-50 p-4 rounded-lg"><p class="font-bold mb-2 text-indigo-700">QUESTION:</p><div id="study-question-display"></div></div>
                    <div class="flex-grow flex flex-col"><p class="font-bold mb-2 text-green-700">YOUR ANSWER:</p><div class="flex space-x-2 mb-2"><button class="tab-button active" data-type="study" data-input="text">Text</button><button class="tab-button" data-type="study" data-input="draw">Draw</button></div><textarea id="study-answer-text" class="w-full flex-grow p-3 border border-slate-300 rounded-lg" placeholder="Type your answer..."></textarea><div id="study-answer-draw" class="hidden canvas-container relative flex-grow"><canvas class="w-full h-full min-h-[300px] bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 cursor-crosshair"></canvas>
                        <div class="absolute top-2 right-2 flex items-center gap-3 bg-white/70 backdrop-blur-sm p-1.5 rounded-lg">
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-black active" data-tool="draw" data-color="#333"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-red-500" data-tool="draw" data-color="#ef4444"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-blue-500" data-tool="draw" data-color="#3b82f6"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-green-500" data-tool="draw" data-color="#22c55e"></button>
                            <div class="w-px h-6 bg-slate-300"></div>
                            <button class="tool-btn eraser-btn w-6 h-6 rounded-full flex items-center justify-center p-0.5" data-tool="erase">
                                <img src="eraser.png" class="w-5 h-5"/>
                            </button>
                            <input type="range" min="1" max="30" value="3" class="line-width-slider w-24 cursor-pointer">
                            <button class="clear-canvas-btn bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded hover:bg-slate-300">Clear</button>
                        </div>
                    </div></div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button id="exit-study-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Exit</button>
                    <button id="submit-answer-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Submit Answer</button>
                </div>
            </div>
            <div id="study-check-panel" class="hidden bg-white w-full max-w-3xl h-full max-h-[90vh] rounded-2xl shadow-2xl flex flex-col p-6">
                <h2 class="text-2xl font-bold mb-4">Check Your Answer</h2>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto">
                    <div><h4 class="font-bold text-green-700 text-lg">Key Answer</h4><div id="key-answer-display" class="mt-2 p-3 bg-green-50 rounded-md h-full"></div></div>
                    <div><h4 class="font-bold text-blue-700 text-lg">Your Answer</h4><div id="user-answer-display" class="mt-2 p-3 bg-blue-50 rounded-md h-full"></div></div>
                </div>
                <div class="mt-6 text-center">
                    <p class="font-semibold mb-3">Did you get it right?</p>
                    <div class="flex justify-center gap-4">
                        <button id="mark-correct-btn" class="w-32 bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">Yes</button>
                        <button id="mark-incorrect-btn" class="w-32 bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition">No</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Review Mode View -->
        <div id="review-mode-view" class="hidden fixed inset-0 bg-slate-100 p-4 z-50 overflow-y-auto">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 sticky top-0 bg-slate-100 py-4 z-10">
                    <h2 id="review-deck-name" class="text-3xl font-bold text-slate-800">Reviewing Deck</h2>
                    <h3 id="final-score" class="text-2xl font-bold text-indigo-600 mt-2 sm:mt-0">Your Score: 0/0</h3>
                    <button id="close-review-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition mt-2 sm:mt-0">Finish Review</button>
                </div>
                <div id="review-cards-container" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        let currentDeck = [];
        let currentlyEditingCardIndex = null;
        let studySession = {
            isActive: false, deck: null, shuffledCards: [], currentIndex: 0, userAnswers: [], score: 0
        };
        let modalTimeout;
        
        // --- CUSTOM MODAL ---
        function showModal(message) {
            const modal = document.getElementById('custom-modal');
            const messageEl = document.getElementById('modal-message');
            messageEl.textContent = message;
            if (modalTimeout) clearTimeout(modalTimeout);
            modal.style.transform = 'translate(-50%, 0)';
            modalTimeout = setTimeout(() => { modal.style.transform = 'translate(-50%, -100%)'; }, 3000);
        }

        // --- CANVAS HANDLING CLASS ---
        class DrawingCanvas {
            constructor(canvasElement) {
                this.canvas = canvasElement; this.ctx = this.canvas.getContext('2d'); this.isDrawing = false; this.lastX = 0; this.lastY = 0;
                this.color = '#333'; this.lineWidth = 3; this.mode = 'draw';
                this.resizeCanvas(); this.addEventListeners();
            }
            resizeCanvas() { const rect = this.canvas.getBoundingClientRect(); this.canvas.width = rect.width; this.canvas.height = rect.height; }
            addEventListeners() {
                window.addEventListener('resize', () => this.resizeCanvas());
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e)); this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing()); this.canvas.addEventListener('mouseout', () => this.stopDrawing());
                this.canvas.addEventListener('touchstart', (e) => this.startDrawing(e.touches[0])); this.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e.touches[0]); });
                this.canvas.addEventListener('touchend', () => this.stopDrawing());
            }
            getCoords(e) { const rect = this.canvas.getBoundingClientRect(); return { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
            startDrawing(e) { this.isDrawing = true; const { x, y } = this.getCoords(e);[this.lastX, this.lastY] = [x, y]; }
            draw(e) {
                if (!this.isDrawing) return; const { x, y } = this.getCoords(e);
                this.ctx.globalCompositeOperation = this.mode === 'erase' ? 'destination-out' : 'source-over';
                this.ctx.beginPath(); this.ctx.moveTo(this.lastX, this.lastY); this.ctx.lineTo(x, y);
                this.ctx.strokeStyle = this.color; this.ctx.lineWidth = this.lineWidth;
                this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round'; this.ctx.stroke();
                [this.lastX, this.lastY] = [x, y];
            }
            stopDrawing() { this.isDrawing = false; }
            clear() { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
            setColor(newColor) { this.color = newColor; }
            setLineWidth(newWidth) { this.lineWidth = newWidth; }
            setMode(newMode) { this.mode = newMode; }
            getDataURL() { return this.canvas.toDataURL(); }
            isEmpty() { const p = new Uint32Array(this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height).data.buffer); return !p.some(c => c !== 0); }
            loadImage(dataURL) {
                const img = new Image();
                img.onload = () => { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.ctx.drawImage(img, 0, 0); };
                img.src = dataURL;
            }
        }
        
        // --- UI ELEMENT REFERENCES ---
        const mainContent = document.getElementById('main-content');
        const cardCreatorFormEl = document.getElementById('card-creator-form');
        const decksListEl = document.getElementById('decks-list');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        let creatorCanvasQ, creatorCanvasA, studyCanvas;
        
        // --- LOCAL STORAGE LOGIC ---
        function getSavedDecks() { return JSON.parse(localStorage.getItem('eStarCardsDecks') || '[]'); }
        function saveDecks(decks) { localStorage.setItem('eStarCardsDecks', JSON.stringify(decks)); }

        function saveCurrentDeck() {
            const deckName = document.getElementById('deck-name-input').value.trim();
            const faculty = document.getElementById('faculty-select').value;
            if (!deckName || currentDeck.length === 0 || faculty === 'none') {
                showModal("Please provide a deck name, select a faculty, and add at least one card.");
                return;
            }
            const newDeck = { id: Date.now().toString(), name: deckName, faculty: faculty, cards: currentDeck, createdAt: new Date().toISOString() };
            const decks = getSavedDecks();
            decks.push(newDeck);
            saveDecks(decks);
            
            resetCreatorForm();
            
            document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
            document.querySelector('.filter-button[data-faculty="all"]').classList.add('active');
            loadAndRenderDecks();
        }

        function deleteDeck(deckId) {
            let decks = getSavedDecks();
            decks = decks.filter(deck => deck.id !== deckId);
            saveDecks(decks);
            const activeFilter = document.querySelector('.filter-button.active').dataset.faculty;
            loadAndRenderDecks(activeFilter);
        }

        // --- CONFIRMATION MODAL LOGIC ---
        function showConfirm(message, onConfirm) {
            confirmModalMessage.textContent = message;
            confirmModal.classList.remove('hidden');
            const handleOk = () => { onConfirm(); hideConfirm(); };
            const handleCancel = () => { hideConfirm(); };
            const hideConfirm = () => {
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', handleOk);
                confirmCancelBtn.removeEventListener('click', handleCancel);
            };
            confirmOkBtn.addEventListener('click', handleOk, { once: true });
            confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
        }

        // --- UI RENDERING ---
        function loadAndRenderDecks(filter = 'all') {
            const decks = getSavedDecks();
            decksListEl.innerHTML = '';
            const filteredDecks = filter === 'all' ? decks : decks.filter(d => d.faculty === filter);
            if (filteredDecks.length === 0) {
                decksListEl.innerHTML = `<p class="text-slate-500 col-span-full">No decks found for this filter.</p>`;
            } else {
                filteredDecks.forEach(deck => renderDeck(deck));
            }
        }

        function renderDeck(deck) {
            const cardCount = deck.cards ? deck.cards.length : 0;
            const deckEl = document.createElement('div');
            deckEl.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col';
            deckEl.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-indigo-800">${deck.name}</h3>
                        <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${deck.faculty.toUpperCase()}</span>
                    </div>
                    <p class="text-slate-600 mt-2">${cardCount} cards</p>
                </div>
                <div class="flex gap-2 mt-4">
                    <button data-deck-id="${deck.id}" class="study-btn w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Study</button>
                    <button data-deck-id="${deck.id}" class="delete-btn w-auto bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Delete</button>
                </div>
            `;
            deckEl.querySelector('.study-btn').addEventListener('click', () => startStudySession(getSavedDecks().find(d => d.id === deck.id).cards, deck.name));
            deckEl.querySelector('.delete-btn').addEventListener('click', () => showConfirm('Are you sure you want to delete this deck?', () => deleteDeck(deck.id)));
            decksListEl.appendChild(deckEl);
        }
        
        // --- CREATOR EDIT LOGIC ---
        function renderCurrentDeckList() {
            const listEl = document.getElementById('current-cards-list');
            listEl.innerHTML = '';
            document.getElementById('card-count').textContent = currentDeck.length;

            if (currentDeck.length === 0) {
                 listEl.innerHTML = `<p class="text-slate-500 text-center">No cards added yet.</p>`;
                return;
            }

            currentDeck.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'p-3 bg-slate-50 rounded-lg flex items-center justify-between';
                const questionPreview = card.questionType === 'text' ? `<p class="truncate">${card.questionContent}</p>` : `<img src="${card.questionContent}" class="w-16 h-10 object-cover rounded">`;
                cardEl.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">${questionPreview}</div>
                    <div class="flex gap-2">
                        <button class="edit-card-btn bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-blue-600" data-index="${index}">Edit</button>
                        <button class="delete-card-btn bg-red-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-red-600" data-index="${index}">Delete</button>
                    </div>
                `;
                 cardEl.querySelector('.edit-card-btn').addEventListener('click', () => editCardInCreator(index));
                cardEl.querySelector('.delete-card-btn').addEventListener('click', () => {
                    currentDeck.splice(index, 1);
                    renderCurrentDeckList();
                });
                listEl.appendChild(cardEl);
            });
        }
        
        function editCardInCreator(index) {
            const card = currentDeck[index];
            currentlyEditingCardIndex = index;

            const qText = document.getElementById('creator-question-text-input');
            const aText = document.getElementById('creator-answer-text-input');
            qText.value = card.questionType === 'text' ? card.questionContent : '';
            aText.value = card.answerType === 'text' ? card.answerContent : '';
            creatorCanvasQ.clear();
            creatorCanvasA.clear();
            if (card.questionType === 'draw') creatorCanvasQ.loadImage(card.questionContent);
            if (card.answerType === 'draw') creatorCanvasA.loadImage(card.answerContent);
            
            document.querySelector(`#card-creator-form .tab-button[data-type="question"][data-input="${card.questionType}"]`).click();
            document.querySelector(`#card-creator-form .tab-button[data-type="answer"][data-input="${card.answerType}"]`).click();

            document.getElementById('add-card-btn').textContent = 'Save Changes';
            document.getElementById('add-card-btn').classList.replace('bg-green-500', 'bg-blue-500');
        }

        function resetCreatorForm() {
            document.getElementById('deck-name-input').value = '';
            document.getElementById('faculty-select').value = 'none';
            currentDeck = [];
            currentlyEditingCardIndex = null;
            renderCurrentDeckList();
            
            document.getElementById('creator-question-text-input').value = '';
            document.getElementById('creator-answer-text-input').value = '';
            creatorCanvasQ.clear();
            creatorCanvasA.clear();
            
            const addBtn = document.getElementById('add-card-btn');
            addBtn.textContent = 'Add Card to Deck';
            addBtn.classList.replace('bg-blue-500', 'bg-green-500');
        }

        // --- EVENT LISTENERS & LOGIC ---
        function setupEventListeners() {
            // Main page listeners
            document.getElementById('save-deck-btn').addEventListener('click', saveCurrentDeck);
            document.getElementById('faculty-filter-buttons').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadAndRenderDecks(e.target.dataset.faculty);
                }
            });

            // Study mode listeners
            document.getElementById('exit-study-btn').addEventListener('click', endStudySession);
            document.getElementById('submit-answer-btn').addEventListener('click', processAnswerSubmission);
            document.getElementById('mark-correct-btn').addEventListener('click', () => markAnswer(true));
            document.getElementById('mark-incorrect-btn').addEventListener('click', () => markAnswer(false));
            document.getElementById('close-review-btn').addEventListener('click', () => {
                document.getElementById('review-mode-view').classList.add('hidden');
                mainContent.classList.remove('hidden');
            });
        }
        
        // --- FORM & CANVAS SETUP ---
        function createCardFormHTML(idPrefix) {
            return `
                <div class="mb-6">
                    <label class="block text-lg font-semibold mb-2">Question:</label>
                    <div class="flex space-x-2 mb-2">
                        <button class="tab-button active" data-type="question" data-input="text">Text</button>
                        <button class="tab-button" data-type="question" data-input="draw">Draw</button>
                    </div>
                    <textarea id="${idPrefix}-question-text-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Type your question here..."></textarea>
                    <div id="${idPrefix}-question-draw-input" class="hidden canvas-container relative">
                        <canvas class="w-full h-80 bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 cursor-crosshair"></canvas>
                         <div class="absolute top-2 right-2 flex items-center gap-3 bg-white/70 backdrop-blur-sm p-1.5 rounded-lg">
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-black active" data-tool="draw" data-color="#333"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-red-500" data-tool="draw" data-color="#ef4444"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-blue-500" data-tool="draw" data-color="#3b82f6"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-green-500" data-tool="draw" data-color="#22c55e"></button>
                            <div class="w-px h-6 bg-slate-300"></div>
                            <button class="tool-btn eraser-btn w-6 h-6 rounded-full flex items-center justify-center p-0.5" data-tool="erase"><img src="eraser.png"/></button>
                            <input type="range" min="1" max="30" value="3" class="line-width-slider w-24 cursor-pointer">
                            <button class="clear-canvas-btn bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded hover:bg-slate-300">Clear</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-lg font-semibold mb-2">Answer:</label>
                    <div class="flex space-x-2 mb-2">
                        <button class="tab-button active" data-type="answer" data-input="text">Text</button>
                        <button class="tab-button" data-type="answer" data-input="draw">Draw</button>
                    </div>
                    <textarea id="${idPrefix}-answer-text-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Type the key answer here..."></textarea>
                    <div id="${idPrefix}-answer-draw-input" class="hidden canvas-container relative">
                        <canvas class="w-full h-80 bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 cursor-crosshair"></canvas>
                         <div class="absolute top-2 right-2 flex items-center gap-3 bg-white/70 backdrop-blur-sm p-1.5 rounded-lg">
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-black active" data-tool="draw" data-color="#333"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-red-500" data-tool="draw" data-color="#ef4444"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-blue-500" data-tool="draw" data-color="#3b82f6"></button>
                            <button class="tool-btn color-btn w-6 h-6 rounded-full bg-green-500" data-tool="draw" data-color="#22c55e"></button>
                            <div class="w-px h-6 bg-slate-300"></div>
                            <button class="tool-btn eraser-btn w-6 h-6 rounded-full flex items-center justify-center p-0.5" data-tool="erase"><img src="eraser.png" class="w-5 h-5"/></button>
                            <input type="range" min="1" max="30" value="3" class="line-width-slider w-24 cursor-pointer">
                            <button class="clear-canvas-btn bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded hover:bg-slate-300">Clear</button>
                        </div>
                    </div>
                </div>
                <button id="add-card-btn" class="mt-6 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition shadow-sm">Add Card to Deck</button>
            `;
        }

        function initializeForm(formContainer, idPrefix, submitHandler) {
            formContainer.innerHTML = createCardFormHTML(idPrefix);
            const qCanvas = new DrawingCanvas(document.querySelector(`#${idPrefix}-question-draw-input canvas`));
            const aCanvas = new DrawingCanvas(document.querySelector(`#${idPrefix}-answer-draw-input canvas`));

            formContainer.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type, input = button.dataset.input;
                    formContainer.querySelectorAll(`.tab-button[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const textInput = formContainer.querySelector(`#${idPrefix}-${type}-text-input`);
                    const drawInput = formContainer.querySelector(`#${idPrefix}-${type}-draw-input`);
                    if (input === 'text') { textInput.classList.remove('hidden'); drawInput.classList.add('hidden'); } 
                    else { textInput.classList.add('hidden'); drawInput.classList.remove('hidden');
                        if (type === 'question') qCanvas.resizeCanvas(); else aCanvas.resizeCanvas();
                    }
                });
            });

            formContainer.querySelectorAll('.canvas-container').forEach(container => {
                const canvasInstance = container.id.includes('question') ? qCanvas : aCanvas;
                container.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelector('.tool-btn.active')?.classList.remove('active');
                        btn.classList.add('active');
                        const tool = btn.dataset.tool;
                        canvasInstance.setMode(tool);
                        if (tool === 'draw') canvasInstance.setColor(btn.dataset.color);
                    });
                });
                container.querySelector('.line-width-slider').addEventListener('input', (e) => canvasInstance.setLineWidth(e.target.value));
                container.querySelector('.clear-canvas-btn').addEventListener('click', () => canvasInstance.clear());
            });
            formContainer.querySelector('#add-card-btn').addEventListener('click', submitHandler);
            return { qCanvas, aCanvas };
        }

        // --- STUDY SESSION LOGIC ---
        function startStudySession(deckCards, deckName) {
            if (!deckCards || deckCards.length === 0) { showModal("This deck has no cards!"); return; }
            studySession = { isActive: true, deck: deckCards, shuffledCards: [...deckCards].sort(() => Math.random() - 0.5), currentIndex: 0, userAnswers: [], score: 0 };
            document.getElementById('study-deck-name').textContent = `Studying: ${deckName}`;
            mainContent.classList.add('hidden');
            document.getElementById('study-mode-view').classList.remove('hidden');
            displayCurrentStudyCard();
        }
        
        function displayCurrentStudyCard() {
            document.getElementById('study-check-panel').classList.add('hidden');
            document.getElementById('study-question-panel').classList.remove('hidden');
            const card = studySession.shuffledCards[studySession.currentIndex];
            const displayEl = document.getElementById('study-question-display');
            document.getElementById('study-progress').textContent = `Card ${studySession.currentIndex + 1} / ${studySession.shuffledCards.length}`;
            if (card.questionType === 'text') { displayEl.innerHTML = `<p class="text-slate-800 text-lg whitespace-pre-wrap">${card.questionContent}</p>`; } 
            else { displayEl.innerHTML = `<img src="${card.questionContent}" class="max-w-full h-auto rounded-md border" alt="Drawn Question">`; }
            studyCanvas.clear();
            document.getElementById('study-answer-text').value = '';
        }

        function processAnswerSubmission() {
            const answerInputType = document.querySelector('#study-mode-view .tab-button[data-type="study"].active').dataset.input;
            let userAnswer;
            if (answerInputType === 'text') {
                const userAnswerText = document.getElementById('study-answer-text').value.trim();
                userAnswer = { type: 'text', content: userAnswerText || '(No answer given)' };
            } else {
                if (studyCanvas.isEmpty()) { userAnswer = { type: 'text', content: '(No answer given)' }; } 
                else { userAnswer = { type: 'draw', content: studyCanvas.getDataURL() }; }
            }
            studySession.userAnswers.push(userAnswer);
            showAnswerCheck();
        }

        function showAnswerCheck() {
            document.getElementById('study-question-panel').classList.add('hidden');
            document.getElementById('study-check-panel').classList.remove('hidden');
            const card = studySession.shuffledCards[studySession.currentIndex];
            const userAnswer = studySession.userAnswers[studySession.currentIndex];
            const keyAnswerEl = document.getElementById('key-answer-display');
            const userAnswerEl = document.getElementById('user-answer-display');
            keyAnswerEl.innerHTML = card.answerType === 'text' ? `<p class="whitespace-pre-wrap">${card.answerContent}</p>` : `<img src="${card.answerContent}" class="max-w-full h-auto rounded-md border" alt="Drawn Key Answer">`;
            userAnswerEl.innerHTML = userAnswer.type === 'text' ? `<p class="whitespace-pre-wrap">${userAnswer.content}</p>` : `<img src="${userAnswer.content}" class="max-w-full h-auto rounded-md border" alt="Drawn User Answer">`;
        }

        function markAnswer(isCorrect) {
            if (isCorrect) studySession.score++;
            studySession.userAnswers[studySession.currentIndex].isCorrect = isCorrect;
            if (studySession.currentIndex < studySession.shuffledCards.length - 1) {
                studySession.currentIndex++;
                displayCurrentStudyCard();
            } else {
                showReview();
            }
        }

        function endStudySession() {
            studySession.isActive = false;
            document.getElementById('study-mode-view').classList.add('hidden');
            mainContent.classList.remove('hidden');
        }
        
        // --- REVIEW LOGIC ---
        function showReview() {
            endStudySession();
            const reviewContainer = document.getElementById('review-cards-container');
            reviewContainer.innerHTML = '';
            document.getElementById('review-deck-name').textContent = `Review: ${document.getElementById('study-deck-name').textContent.replace('Studying: ', '')}`;
            document.getElementById('final-score').textContent = `Your Score: ${studySession.score} / ${studySession.shuffledCards.length}`;
            studySession.shuffledCards.forEach((card, index) => {
                const userAnswer = studySession.userAnswers[index];
                const reviewCardEl = document.createElement('div');
                const resultClass = userAnswer.isCorrect ? 'border-green-400' : 'border-red-400';
                reviewCardEl.className = `bg-white p-6 rounded-xl shadow-lg border-2 ${resultClass}`;
                const questionHTML = card.questionType === 'text' ? `<p class="whitespace-pre-wrap">${card.questionContent}</p>` : `<img src="${card.questionContent}" class="max-w-full h-auto rounded-md border" alt="Drawn Question">`;
                const keyAnswerHTML = card.answerType === 'text' ? `<p class="whitespace-pre-wrap">${card.answerContent}</p>` : `<img src="${card.answerContent}" class="max-w-full h-auto rounded-md border" alt="Drawn Key Answer">`;
                const userAnswerHTML = userAnswer.type === 'text' ? `<p class="whitespace-pre-wrap">${userAnswer.content}</p>` : `<img src="${userAnswer.content}" class="max-w-full h-auto rounded-md border" alt="Drawn User Answer">`;
                reviewCardEl.innerHTML = `
                    <div class="mb-4"><h4 class="font-bold text-indigo-700 text-lg">Question ${index + 1}</h4><div class="mt-2 p-3 bg-slate-50 rounded-md">${questionHTML}</div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><h4 class="font-bold text-green-700 text-lg">Key Answer</h4><div class="mt-2 p-3 bg-green-50 rounded-md h-full">${keyAnswerHTML}</div></div>
                        <div><h4 class="font-bold text-blue-700 text-lg">Your Answer</h4><div class="mt-2 p-3 bg-blue-50 rounded-md h-full">${userAnswerHTML}</div></div>
                    </div>`;
                reviewContainer.appendChild(reviewCardEl);
            });
            document.getElementById('review-mode-view').classList.remove('hidden');
        }

        // --- APP INITIALIZATION ---
        window.onload = () => {
            const creatorCanvases = initializeForm(cardCreatorFormEl, 'creator', () => {
                const qType = document.querySelector('#card-creator-form .tab-button[data-type="question"].active').dataset.input;
                const aType = document.querySelector('#card-creator-form .tab-button[data-type="answer"].active').dataset.input;
                let qContent, aContent;
                if (qType === 'text') { qContent = document.getElementById('creator-question-text-input').value.trim(); } else { if (creatorCanvasQ.isEmpty()) { showModal("Question drawing is empty!"); return; } qContent = creatorCanvasQ.getDataURL(); }
                if (aType === 'text') { aContent = document.getElementById('creator-answer-text-input').value.trim(); } else { if (creatorCanvasA.isEmpty()) { showModal("Answer drawing is empty!"); return; } aContent = creatorCanvasA.getDataURL(); }
                if (!qContent || !aContent) { showModal('Please fill out both the question and answer fields.'); return; }
                const newCard = { questionType: qType, questionContent: qContent, answerType: aType, answerContent: aContent };
                
                if (currentlyEditingCardIndex !== null) {
                    currentDeck[currentlyEditingCardIndex] = newCard;
                    currentlyEditingCardIndex = null;
                    const addBtn = document.getElementById('add-card-btn');
                    addBtn.textContent = 'Add Card to Deck';
                    addBtn.classList.replace('bg-blue-500', 'bg-green-500');
                } else {
                    currentDeck.push(newCard);
                }
                
                renderCurrentDeckList();
                document.getElementById('creator-question-text-input').value = ''; 
                document.getElementById('creator-answer-text-input').value = ''; 
                creatorCanvasQ.clear(); 
                creatorCanvasA.clear();
            });
            creatorCanvasQ = creatorCanvases.qCanvas;
            creatorCanvasA = creatorCanvases.aCanvas;

            studyCanvas = new DrawingCanvas(document.querySelector('#study-answer-draw canvas'));
            
            // Dedicated listeners for study mode tabs and tools
            document.querySelectorAll('#study-mode-view .tab-button[data-type="study"]').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('#study-mode-view .tab-button[data-type="study"]').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const input = button.dataset.input;
                    const textInput = document.getElementById('study-answer-text');
                    const drawInput = document.getElementById('study-answer-draw');

                    if (input === 'text') {
                        textInput.classList.remove('hidden');
                        drawInput.classList.add('hidden');
                    } else {
                        textInput.classList.add('hidden');
                        drawInput.classList.remove('hidden');
                        studyCanvas.resizeCanvas();
                    }
                });
            });

            document.querySelector('#study-answer-draw').querySelectorAll('.tool-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelector('#study-answer-draw .tool-btn.active')?.classList.remove('active');
                btn.classList.add('active');
                const tool = btn.dataset.tool;
                studyCanvas.setMode(tool);
                if(tool === 'draw') studyCanvas.setColor(btn.dataset.color);
            }));
            document.querySelector('#study-answer-draw .line-width-slider').addEventListener('input', (e) => studyCanvas.setLineWidth(e.target.value));
            document.querySelector('#study-answer-draw .clear-canvas-btn').addEventListener('click', () => studyCanvas.clear());

            setupEventListeners();
            loadAndRenderDecks();
        };
    </script>
</body>
</html>
